# Java åå°„ï¼ˆReflectionï¼‰è¶…è¯¦ç»†è§£æ

## ğŸ“Œ **ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ**

**åå°„**å°±æ˜¯**åœ¨è¿è¡Œæ—¶**ï¼š
1. è·å–ç±»çš„å®Œæ•´ä¿¡æ¯
2. åŠ¨æ€åˆ›å»ºå¯¹è±¡
3. åŠ¨æ€è°ƒç”¨æ–¹æ³•
4. è®¿é—®å’Œä¿®æ”¹å­—æ®µ
5. **å³ä½¿è¿™äº›æˆå‘˜æ˜¯ç§æœ‰çš„ï¼**

## ğŸ¯ **ä¸€å¥è¯ç†è§£åå°„**
> **"åå°„æ˜¯ Java çš„ X å…‰ï¼Œèƒ½åœ¨è¿è¡Œæ—¶é€è§†å’Œæ“ä½œç±»çš„å†…éƒ¨ç»“æ„"**

## ğŸ“Š **åå°„èƒ½åšä»€ä¹ˆï¼Ÿ**
```java
// æ­£å¸¸æ–¹å¼ï¼šç¼–è¯‘æ—¶å°±çŸ¥é“ç±»ä¿¡æ¯
Person p = new Person();
p.sayHello();

// åå°„æ–¹å¼ï¼šè¿è¡Œæ—¶æ‰çŸ¥é“ç±»ä¿¡æ¯
Class<?> clazz = Class.forName("com.example.Person");
Object obj = clazz.newInstance();
Method method = clazz.getMethod("sayHello");
method.invoke(obj);
```

## ğŸ”§ **1. è·å– Class å¯¹è±¡çš„ 4 ç§æ–¹å¼**

### **æ–¹å¼1ï¼šç±»å.classï¼ˆæœ€å¸¸ç”¨ï¼‰**
```java
Class<String> stringClass = String.class;
Class<Integer> intClass = int.class;          // åŸºæœ¬ç±»å‹ä¹Ÿå¯ä»¥
Class<Void> voidClass = void.class;
```

### **æ–¹å¼2ï¼šå¯¹è±¡.getClass()**
```java
String str = "Hello";
Class<? extends String> strClass = str.getClass();
```

### **æ–¹å¼3ï¼šClass.forName("å…¨é™å®šç±»å")**
```java
// æœ€çµæ´»çš„å†™æ³•ï¼Œç±»åå¯ä»¥æ˜¯å˜é‡
String className = "java.lang.String";
Class<?> clazz = Class.forName(className);

// å¸¦åˆå§‹åŒ–
Class<?> clazz2 = Class.forName("com.example.User", true, 
                                 ClassLoader.getSystemClassLoader());
```

### **æ–¹å¼4ï¼šClassLoader.loadClass()**
```java
ClassLoader classLoader = Thread.currentThread().getContextClassLoader();
Class<?> clazz = classLoader.loadClass("java.lang.String");
```

### **è·å–æ•°ç»„å’ŒåŸºæœ¬ç±»å‹çš„ Class**
```java
// æ•°ç»„
Class<?> intArrayClass = int[].class;           // int[]
Class<?> stringArrayClass = String[].class;     // String[]
Class<?> twoDArrayClass = int[][].class;        // int[][]

// åŒ…è£…ç±»å’ŒåŸºæœ¬ç±»å‹çš„äº’è½¬
Class<Integer> integerClass = Integer.class;
Class<Integer> intType = Integer.TYPE;          // ç­‰åŒäº int.class

// åˆ¤æ–­
System.out.println(int.class == Integer.TYPE);   // true
System.out.println(int.class == Integer.class);  // false
```

## ğŸ“¦ **2. åˆ›å»ºå¯¹è±¡çš„ 3 ç§æ–¹å¼**

### **æ–¹å¼1ï¼šnewInstance()ï¼ˆå·²è¿‡æ—¶ï¼‰**
```java
// JDK9 å·²è¿‡æ—¶
Class<User> clazz = User.class;
User user = clazz.newInstance();  // å¿…é¡»æœ‰æ— å‚æ„é€ 
```

### **æ–¹å¼2ï¼šConstructor.newInstance()ï¼ˆæ¨èï¼‰**
```java
Class<User> clazz = User.class;

// 1. æ— å‚æ„é€ 
Constructor<User> constructor = clazz.getConstructor();
User user1 = constructor.newInstance();

// 2. æœ‰å‚æ„é€ 
Constructor<User> paramConstructor = clazz.getConstructor(String.class, int.class);
User user2 = paramConstructor.newInstance("å¼ ä¸‰", 25);

// 3. ç§æœ‰æ„é€ ï¼ˆæš´åŠ›åå°„ï¼‰
Constructor<User> privateConstructor = clazz.getDeclaredConstructor();
privateConstructor.setAccessible(true);  // çªç ´ç§æœ‰é™åˆ¶ï¼
User user3 = privateConstructor.newInstance();
```

### **æ–¹å¼3ï¼šä½¿ç”¨ Unsafeï¼ˆä¸æ¨èï¼‰**
```java
// ç»•è¿‡æ„é€ æ–¹æ³•ç›´æ¥åˆ›å»ºå¯¹è±¡ï¼ˆç”šè‡³ä¸è°ƒç”¨æ„é€ å™¨ï¼ï¼‰
import sun.misc.Unsafe;

Field theUnsafe = Unsafe.class.getDeclaredField("theUnsafe");
theUnsafe.setAccessible(true);
Unsafe unsafe = (Unsafe) theUnsafe.get(null);

User user = (User) unsafe.allocateInstance(User.class);
System.out.println(user.getName());  // nullï¼Œæ„é€ æ–¹æ³•æ²¡æ‰§è¡Œï¼
```

## ğŸ” **3. è·å–å’Œæ“ä½œå­—æ®µï¼ˆFieldï¼‰**

### **è·å–å­—æ®µ**
```java
public class User {
    private String name;
    public int age;
    protected String email;
    static int count;
}

Class<User> clazz = User.class;

// è·å–æ‰€æœ‰å…¬å…±å­—æ®µï¼ˆåŒ…æ‹¬çˆ¶ç±»çš„ï¼‰
Field[] publicFields = clazz.getFields();
// è¾“å‡ºï¼šage, countï¼ˆå› ä¸ºcountæ˜¯public staticï¼‰

// è·å–æœ¬ç±»æ‰€æœ‰å­—æ®µï¼ˆä¸åŒ…æ‹¬çˆ¶ç±»ï¼‰
Field[] allFields = clazz.getDeclaredFields();
// è¾“å‡ºï¼šname, age, email, countï¼ˆæ‰€æœ‰ä¿®é¥°ç¬¦ï¼‰

// è·å–ç‰¹å®šå­—æ®µ
Field nameField = clazz.getDeclaredField("name");   // è·å–ç§æœ‰å­—æ®µ
Field ageField = clazz.getField("age");             // è·å–å…¬å…±å­—æ®µ
```

### **æ“ä½œå­—æ®µå€¼**
```java
User user = new User("å¼ ä¸‰", 25);

// 1. è·å–å­—æ®µå€¼
Field ageField = User.class.getDeclaredField("age");
int age = (int) ageField.get(user);  // 25

// 2. è®¾ç½®å­—æ®µå€¼
ageField.set(user, 30);  // user.age = 30

// 3. æ“ä½œç§æœ‰å­—æ®µï¼ˆéœ€è¦çªç ´è®¿é—®é™åˆ¶ï¼‰
Field nameField = User.class.getDeclaredField("name");
nameField.setAccessible(true);  // å…³é”®ï¼

String name = (String) nameField.get(user);  // è·å–ç§æœ‰å­—æ®µ
nameField.set(user, "æå››");                 // ä¿®æ”¹ç§æœ‰å­—æ®µ

// 4. æ“ä½œé™æ€å­—æ®µ
Field countField = User.class.getDeclaredField("count");
countField.set(null, 100);  // é™æ€å­—æ®µä¸éœ€è¦å¯¹è±¡å®ä¾‹
Object count = countField.get(null);  // è·å–é™æ€å­—æ®µ

// 5. è·å–å­—æ®µä¿¡æ¯
System.out.println("å­—æ®µå: " + nameField.getName());
System.out.println("ç±»å‹: " + nameField.getType());  // class java.lang.String
System.out.println("ä¿®é¥°ç¬¦: " + Modifier.toString(nameField.getModifiers()));  // private
System.out.println("æ˜¯å¦æ˜¯final: " + Modifier.isFinal(nameField.getModifiers()));
```

## ğŸ¯ **4. è·å–å’Œè°ƒç”¨æ–¹æ³•ï¼ˆMethodï¼‰**

### **è·å–æ–¹æ³•**
```java
public class Calculator {
    public int add(int a, int b) { return a + b; }
    private int multiply(int a, int b) { return a * b; }
    public static void print(String msg) { System.out.println(msg); }
}

Class<Calculator> clazz = Calculator.class;

// è·å–æ‰€æœ‰å…¬å…±æ–¹æ³•ï¼ˆåŒ…æ‹¬çˆ¶ç±»çš„toStringã€equalsç­‰ï¼‰
Method[] publicMethods = clazz.getMethods();

// è·å–æœ¬ç±»æ‰€æœ‰æ–¹æ³•
Method[] allMethods = clazz.getDeclaredMethods();

// è·å–ç‰¹å®šæ–¹æ³•
Method addMethod = clazz.getMethod("add", int.class, int.class);
Method multiplyMethod = clazz.getDeclaredMethod("multiply", int.class, int.class);
Method printMethod = clazz.getMethod("print", String.class);
```

### **è°ƒç”¨æ–¹æ³•**
```java
Calculator calc = new Calculator();

// 1. è°ƒç”¨å…¬å…±æ–¹æ³•
Method addMethod = Calculator.class.getMethod("add", int.class, int.class);
int result = (int) addMethod.invoke(calc, 10, 20);  // 30

// 2. è°ƒç”¨ç§æœ‰æ–¹æ³•
Method multiplyMethod = Calculator.class.getDeclaredMethod("multiply", int.class, int.class);
multiplyMethod.setAccessible(true);  // çªç ´ç§æœ‰ï¼
int product = (int) multiplyMethod.invoke(calc, 5, 6);  // 30

// 3. è°ƒç”¨é™æ€æ–¹æ³•
Method printMethod = Calculator.class.getMethod("print", String.class);
printMethod.invoke(null, "Hello Reflection!");  // é™æ€æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnull

// 4. è°ƒç”¨æœ‰è¿”å›å€¼çš„æ–¹æ³•
Method toStringMethod = Object.class.getMethod("toString");
String str = (String) toStringMethod.invoke(calc);

// 5. å¤„ç†å¼‚å¸¸
try {
    Method method = Calculator.class.getMethod("divide", int.class, int.class);
    method.invoke(calc, 10, 0);
} catch (InvocationTargetException e) {
    // è¢«è°ƒç”¨æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸
    Throwable cause = e.getCause();
    System.out.println("æ–¹æ³•å†…éƒ¨å¼‚å¸¸: " + cause.getMessage());
}

// 6. è·å–æ–¹æ³•ä¿¡æ¯
System.out.println("æ–¹æ³•å: " + addMethod.getName());
System.out.println("è¿”å›ç±»å‹: " + addMethod.getReturnType());
System.out.println("å‚æ•°ä¸ªæ•°: " + addMethod.getParameterCount());
System.out.println("å‚æ•°ç±»å‹: " + Arrays.toString(addMethod.getParameterTypes()));
System.out.println("ä¿®é¥°ç¬¦: " + Modifier.toString(addMethod.getModifiers()));
```

## ğŸ—ï¸ **5. æ„é€ æ–¹æ³•ï¼ˆConstructorï¼‰**

```java
public class Person {
    private String name;
    private int age;
    
    public Person() {}
    
    private Person(String name) {
        this.name = name;
    }
    
    public Person(String name, int age) {
        this.name = name;
        this.age = age;
    }
}

Class<Person> clazz = Person.class;

// 1. è·å–æ‰€æœ‰å…¬å…±æ„é€ æ–¹æ³•
Constructor<?>[] publicConstructors = clazz.getConstructors();

// 2. è·å–æ‰€æœ‰æ„é€ æ–¹æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰çš„ï¼‰
Constructor<?>[] allConstructors = clazz.getDeclaredConstructors();

// 3. è·å–ç‰¹å®šæ„é€ æ–¹æ³•
Constructor<Person> defaultConstructor = clazz.getConstructor();  // æ— å‚
Constructor<Person> paramConstructor = clazz.getConstructor(String.class, int.class);
Constructor<Person> privateConstructor = clazz.getDeclaredConstructor(String.class);

// 4. åˆ›å»ºå®ä¾‹
Person p1 = defaultConstructor.newInstance();
Person p2 = paramConstructor.newInstance("å¼ ä¸‰", 25);

// 5. ä½¿ç”¨ç§æœ‰æ„é€ æ–¹æ³•
privateConstructor.setAccessible(true);
Person p3 = privateConstructor.newInstance("æå››");

// 6. è·å–æ„é€ æ–¹æ³•ä¿¡æ¯
System.out.println("å‚æ•°ç±»å‹: " + Arrays.toString(paramConstructor.getParameterTypes()));
System.out.println("æ˜¯å¦å¯å˜å‚æ•°: " + paramConstructor.isVarArgs());
```

## ğŸ“Š **6. å®Œæ•´ç¤ºä¾‹ï¼šåå°„æ“ä½œ POJO**

```java
import java.lang.reflect.*;
import java.util.*;

public class ReflectionDemo {
    
    // è¦æ“ä½œçš„ POJO
    public static class User {
        private String name;
        private int age;
        private List<String> hobbies;
        
        public User() {
            this.hobbies = new ArrayList<>();
        }
        
        public User(String name, int age) {
            this.name = name;
            this.age = age;
            this.hobbies = new ArrayList<>();
        }
        
        public void addHobby(String hobby) {
            this.hobbies.add(hobby);
        }
        
        public void introduce() {
            System.out.println("æˆ‘å«" + name + "ï¼Œä»Šå¹´" + age + "å²");
            if (!hobbies.isEmpty()) {
                System.out.println("çˆ±å¥½ï¼š" + String.join(",", hobbies));
            }
        }
        
        // getters and setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }
        public int getAge() { return age; }
        public void setAge(int age) { this.age = age; }
        public List<String> getHobbies() { return hobbies; }
        public void setHobbies(List<String> hobbies) { this.hobbies = hobbies; }
        
        @Override
        public String toString() {
            return "User{name='" + name + "', age=" + age + ", hobbies=" + hobbies + "}";
        }
    }
    
    public static void main(String[] args) throws Exception {
        // ============ 1. è·å– Class å¯¹è±¡ ============
        Class<User> userClass = User.class;
        System.out.println("ç±»å: " + userClass.getName());        // com.example.User
        System.out.println("ç®€å•ç±»å: " + userClass.getSimpleName()); // User
        System.out.println("åŒ…å: " + userClass.getPackage().getName());
        
        // ============ 2. åˆ›å»ºå¯¹è±¡ ============
        // æ–¹å¼1: ä½¿ç”¨æ— å‚æ„é€ 
        User user1 = userClass.newInstance();  // è¿‡æ—¶æ–¹æ³•
        
        // æ–¹å¼2: ä½¿ç”¨æ„é€ å™¨
        Constructor<User> constructor = userClass.getConstructor(String.class, int.class);
        User user2 = constructor.newInstance("å¼ ä¸‰", 25);
        
        // ============ 3. è·å–å¹¶æ“ä½œå­—æ®µ ============
        Field nameField = userClass.getDeclaredField("name");
        Field ageField = userClass.getDeclaredField("age");
        Field hobbiesField = userClass.getDeclaredField("hobbies");
        
        // çªç ´ç§æœ‰è®¿é—®é™åˆ¶
        nameField.setAccessible(true);
        ageField.setAccessible(true);
        hobbiesField.setAccessible(true);
        
        // è®¾ç½®å­—æ®µå€¼
        nameField.set(user2, "æå››");
        ageField.set(user2, 30);
        
        // è·å–å­—æ®µå€¼
        System.out.println("å§“å: " + nameField.get(user2));
        System.out.println("å¹´é¾„: " + ageField.get(user2));
        
        // æ“ä½œé›†åˆå­—æ®µ
        List<String> hobbies = (List<String>) hobbiesField.get(user2);
        hobbies.add("ç¯®çƒ");
        hobbies.add("æ¸¸æ³³");
        
        // ============ 4. è·å–å¹¶è°ƒç”¨æ–¹æ³• ============
        // è·å–å…¬å…±æ–¹æ³•
        Method setNameMethod = userClass.getMethod("setName", String.class);
        Method getNameMethod = userClass.getMethod("getName");
        Method addHobbyMethod = userClass.getMethod("addHobby", String.class);
        Method introduceMethod = userClass.getMethod("introduce");
        
        // è°ƒç”¨setter
        setNameMethod.invoke(user2, "ç‹äº”");
        
        // è°ƒç”¨getter
        String name = (String) getNameMethod.invoke(user2);
        System.out.println("è·å–åˆ°çš„å§“å: " + name);
        
        // è°ƒç”¨æ™®é€šæ–¹æ³•
        addHobbyMethod.invoke(user2, "è¯»ä¹¦");
        introduceMethod.invoke(user2);
        
        // ============ 5. è·å–æ‰€æœ‰ä¿¡æ¯ ============
        System.out.println("\n=== ç±»ä¿¡æ¯ ===");
        System.out.println("ä¿®é¥°ç¬¦: " + Modifier.toString(userClass.getModifiers()));
        System.out.println("çˆ¶ç±»: " + userClass.getSuperclass().getName());
        
        // å®ç°çš„æ¥å£
        Class<?>[] interfaces = userClass.getInterfaces();
        System.out.println("å®ç°çš„æ¥å£: " + Arrays.toString(interfaces));
        
        // æ‰€æœ‰å­—æ®µ
        System.out.println("\n=== å­—æ®µåˆ—è¡¨ ===");
        for (Field field : userClass.getDeclaredFields()) {
            System.out.println(Modifier.toString(field.getModifiers()) + " " +
                             field.getType().getSimpleName() + " " + 
                             field.getName());
        }
        
        // æ‰€æœ‰æ–¹æ³•
        System.out.println("\n=== æ–¹æ³•åˆ—è¡¨ ===");
        for (Method method : userClass.getDeclaredMethods()) {
            System.out.print(Modifier.toString(method.getModifiers()) + " " +
                           method.getReturnType().getSimpleName() + " " +
                           method.getName() + "(");
            
            Class<?>[] params = method.getParameterTypes();
            for (int i = 0; i < params.length; i++) {
                System.out.print(params[i].getSimpleName());
                if (i < params.length - 1) System.out.print(", ");
            }
            System.out.println(")");
        }
        
        // ============ 6. åŠ¨æ€ä»£ç†ç¤ºä¾‹ ============
        System.out.println("\n=== åŠ¨æ€ä»£ç† ===");
        User realUser = new User("ä»£ç†ç”¨æˆ·", 20);
        
        // åˆ›å»ºä»£ç†å¯¹è±¡
        Object proxy = Proxy.newProxyInstance(
            userClass.getClassLoader(),
            new Class<?>[]{userClass},  // è¦ä»£ç†çš„æ¥å£
            new InvocationHandler() {
                @Override
                public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                    System.out.println("ã€ä»£ç†å‰ã€‘è°ƒç”¨æ–¹æ³•: " + method.getName());
                    Object result = method.invoke(realUser, args);
                    System.out.println("ã€ä»£ç†åã€‘æ–¹æ³•è¿”å›: " + result);
                    return result;
                }
            }
        );
        
        User proxyUser = (User) proxy;
        proxyUser.setName("ä»£ç†ä¿®æ”¹çš„åå­—");
        System.out.println("æœ€ç»ˆå§“å: " + proxyUser.getName());
    }
}
```

## ğŸš€ **7. é«˜çº§åå°„æŠ€å·§**

### **æ“ä½œæ³›å‹**
```java
public class GenericDemo<T> {
    private List<T> items;
    private Map<String, T> map;
    
    public List<T> getItems() { return items; }
}

// è·å–æ³›å‹ä¿¡æ¯
Class<GenericDemo> clazz = GenericDemo.class;

// è·å–å­—æ®µçš„æ³›å‹ç±»å‹
Field itemsField = clazz.getDeclaredField("items");
Type genericType = itemsField.getGenericType();

if (genericType instanceof ParameterizedType) {
    ParameterizedType pt = (ParameterizedType) genericType;
    System.out.println("åŸå§‹ç±»å‹: " + pt.getRawType());  // java.util.List
    
    Type[] actualTypes = pt.getActualTypeArguments();
    System.out.println("æ³›å‹å‚æ•°: " + actualTypes[0]);  // T
}

// è·å–æ–¹æ³•çš„è¿”å›ç±»å‹æ³›å‹
Method getItemsMethod = clazz.getMethod("getItems");
Type returnType = getItemsMethod.getGenericReturnType();
```

### **æ“ä½œæ³¨è§£**
```java
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD, ElementType.FIELD})
@interface MyAnnotation {
    String value() default "";
    int version() default 1;
}

@MyAnnotation(value = "æµ‹è¯•ç±»", version = 2)
class AnnotatedClass {
    @MyAnnotation("å§“åå­—æ®µ")
    private String name;
    
    @MyAnnotation("æ‰“å°æ–¹æ³•")
    public void print() {}
}

// è·å–ç±»ä¸Šçš„æ³¨è§£
MyAnnotation classAnnotation = AnnotatedClass.class.getAnnotation(MyAnnotation.class);
if (classAnnotation != null) {
    System.out.println("ç±»æ³¨è§£å€¼: " + classAnnotation.value());
    System.out.println("ç‰ˆæœ¬: " + classAnnotation.version());
}

// è·å–å­—æ®µä¸Šçš„æ³¨è§£
Field field = AnnotatedClass.class.getDeclaredField("name");
MyAnnotation fieldAnnotation = field.getAnnotation(MyAnnotation.class);

// è·å–æ–¹æ³•ä¸Šçš„æ³¨è§£
Method method = AnnotatedClass.class.getMethod("print");
MyAnnotation methodAnnotation = method.getAnnotation(MyAnnotation.class);

// è·å–æ‰€æœ‰æ³¨è§£
Annotation[] annotations = AnnotatedClass.class.getAnnotations();
```

### **åŠ¨æ€ä¿®æ”¹ final å­—æ®µ**
```java
class FinalFieldClass {
    public final String VALUE = "ä¸å¯ä¿®æ”¹";
    private static final int COUNT = 100;
}

// ä¿®æ”¹å®ä¾‹çš„finalå­—æ®µ
FinalFieldClass obj = new FinalFieldClass();
Field valueField = FinalFieldClass.class.getDeclaredField("VALUE");

// 1. ç§»é™¤finalä¿®é¥°ç¬¦
Field modifiersField = Field.class.getDeclaredField("modifiers");
modifiersField.setAccessible(true);
modifiersField.setInt(valueField, valueField.getModifiers() & ~Modifier.FINAL);

// 2. ä¿®æ”¹å€¼
valueField.setAccessible(true);
valueField.set(obj, "å·²ä¿®æ”¹");

System.out.println(obj.VALUE);  // "å·²ä¿®æ”¹"

// ä¿®æ”¹static finalå­—æ®µï¼ˆéœ€è¦æ›´hackçš„æ–¹å¼ï¼‰
Field countField = FinalFieldClass.class.getDeclaredField("COUNT");

// å¯¹äºé™æ€finalå­—æ®µï¼Œéœ€è¦å…ˆè®¾ä¸ºå¯è®¿é—®ï¼Œç„¶åä¿®æ”¹
modifiersField.setInt(countField, countField.getModifiers() & ~Modifier.FINAL);
countField.setAccessible(true);

// ä½¿ç”¨åå°„è®¾ç½®å€¼
countField.set(null, 200);

// æ³¨æ„ï¼šJVMå¯èƒ½ä¼šå†…è”å¸¸é‡ï¼Œä¿®æ”¹å¯èƒ½ä¸ä¼šç«‹å³ç”Ÿæ•ˆ
```

### **æ–¹æ³•å¥æŸ„ï¼ˆMethodHandleï¼‰ - JDK7+**
```java
import java.lang.invoke.*;

// æ¯”åå°„æ›´å¿«çš„æ›¿ä»£æ–¹æ¡ˆ
public class MethodHandleDemo {
    public static class Calculator {
        public int add(int a, int b) { return a + b; }
    }
    
    public static void main(String[] args) throws Throwable {
        MethodHandles.Lookup lookup = MethodHandles.lookup();
        Calculator calc = new Calculator();
        
        // è·å–æ–¹æ³•å¥æŸ„
        MethodHandle addHandle = lookup.findVirtual(
            Calculator.class, 
            "add", 
            MethodType.methodType(int.class, int.class, int.class)
        );
        
        // è°ƒç”¨æ–¹æ³•ï¼ˆæ¯”åå°„å¿«ï¼‰
        int result = (int) addHandle.invoke(calc, 10, 20);
        System.out.println("ç»“æœ: " + result);
        
        // ç»‘å®šæ¥æ”¶è€…ï¼ˆéƒ¨åˆ†åº”ç”¨ï¼‰
        MethodHandle boundHandle = addHandle.bindTo(calc);
        int result2 = (int) boundHandle.invoke(15, 25);
        System.out.println("ç»“æœ2: " + result2);
    }
}
```

## âš ï¸ **8. åå°„çš„æ³¨æ„äº‹é¡¹**

### **æ€§èƒ½é—®é¢˜**
```java
// âŒ åå°„è°ƒç”¨æ¯”ç›´æ¥è°ƒç”¨æ…¢å¾ˆå¤šï¼ˆçº¦50-100å€ï¼‰
long start = System.currentTimeMillis();
for (int i = 0; i < 1000000; i++) {
    method.invoke(obj, args);  // åå°„è°ƒç”¨
}
long end = System.currentTimeMillis();
System.out.println("åå°„è€—æ—¶: " + (end - start) + "ms");

// âœ… ä¼˜åŒ–æ–¹æ¡ˆ1ï¼šç¼“å­˜åå°„å¯¹è±¡
private static final Method CACHED_METHOD;
static {
    try {
        CACHED_METHOD = MyClass.class.getMethod("myMethod");
        CACHED_METHOD.setAccessible(true);  // ä¸€æ¬¡æ€§è®¾ç½®
    } catch (Exception e) {
        throw new RuntimeException(e);
    }
}

// âœ… ä¼˜åŒ–æ–¹æ¡ˆ2ï¼šä½¿ç”¨MethodHandleï¼ˆJDK7+ï¼‰

// âœ… ä¼˜åŒ–æ–¹æ¡ˆ3ï¼šä½¿ç”¨å­—èŠ‚ç ç”Ÿæˆï¼ˆå¦‚CGLIBã€ByteBuddyï¼‰
```

### **å®‰å…¨é—®é¢˜**
```java
// 1. ç ´åå°è£…æ€§ï¼ˆå¯ä»¥è®¿é—®ç§æœ‰æˆå‘˜ï¼‰
field.setAccessible(true);  // å…³é—­è®¿é—®æ£€æŸ¥

// 2. ç»•è¿‡å®‰å…¨ç®¡ç†å™¨
SecurityManager sm = System.getSecurityManager();
if (sm != null) {
    sm.checkPermission(new ReflectPermission("suppressAccessChecks"));
}

// 3. å»ºè®®ï¼šåœ¨å®‰å…¨ç¯å¢ƒä½¿ç”¨ï¼Œæˆ–é™åˆ¶åå°„æƒé™
```

### **å•ä¾‹æ¨¡å¼è¢«ç ´å**
```java
public class Singleton {
    private static final Singleton INSTANCE = new Singleton();
    private Singleton() {}  // ç§æœ‰æ„é€ 
    
    public static Singleton getInstance() {
        return INSTANCE;
    }
}

// ä½¿ç”¨åå°„ç ´åå•ä¾‹
Constructor<Singleton> constructor = Singleton.class.getDeclaredConstructor();
constructor.setAccessible(true);
Singleton instance1 = constructor.newInstance();
Singleton instance2 = constructor.newInstance();

System.out.println(instance1 == instance2);  // falseï¼å•ä¾‹è¢«ç ´å

// é˜²å¾¡æ–¹æ³•ï¼šåœ¨æ„é€ æ–¹æ³•ä¸­æ£€æŸ¥
private Singleton() {
    if (INSTANCE != null) {
        throw new RuntimeException("å•ä¾‹æ¨¡å¼ç¦æ­¢åå°„è°ƒç”¨ï¼");
    }
}
```

## ğŸ¯ **9. å®é™…åº”ç”¨åœºæ™¯**

### **åœºæ™¯1ï¼šSpring IOC å®¹å™¨**
```java
// Springé€šè¿‡åå°„åˆ›å»ºBeanå¹¶æ³¨å…¥ä¾èµ–
public class BeanFactory {
    private Map<String, Object> beans = new HashMap<>();
    
    public void registerBean(String name, Class<?> clazz) throws Exception {
        // 1. é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡
        Object bean = clazz.newInstance();
        
        // 2. é€šè¿‡åå°„æ³¨å…¥ä¾èµ–
        for (Field field : clazz.getDeclaredFields()) {
            if (field.isAnnotationPresent(Autowired.class)) {
                field.setAccessible(true);
                Object dependency = getBean(field.getType());
                field.set(bean, dependency);
            }
        }
        
        beans.put(name, bean);
    }
    
    public <T> T getBean(Class<T> type) {
        return beans.values().stream()
            .filter(type::isInstance)
            .map(type::cast)
            .findFirst()
            .orElse(null);
    }
}
```

### **åœºæ™¯2ï¼šJSONåºåˆ—åŒ–/ååºåˆ—åŒ–**
```java
public class JsonUtil {
    // å¯¹è±¡è½¬JSON
    public static String toJson(Object obj) throws IllegalAccessException {
        Class<?> clazz = obj.getClass();
        StringBuilder json = new StringBuilder("{");
        
        Field[] fields = clazz.getDeclaredFields();
        for (int i = 0; i < fields.length; i++) {
            Field field = fields[i];
            field.setAccessible(true);
            
            Object value = field.get(obj);
            json.append("\"").append(field.getName()).append("\":");
            
            if (value instanceof String) {
                json.append("\"").append(value).append("\"");
            } else {
                json.append(value);
            }
            
            if (i < fields.length - 1) json.append(",");
        }
        
        json.append("}");
        return json.toString();
    }
    
    // JSONè½¬å¯¹è±¡
    public static <T> T fromJson(String json, Class<T> clazz) throws Exception {
        T obj = clazz.newInstance();
        
        // ç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦è§£æJSON
        Map<String, Object> map = parseJson(json);
        
        for (Map.Entry<String, Object> entry : map.entrySet()) {
            Field field = clazz.getDeclaredField(entry.getKey());
            field.setAccessible(true);
            field.set(obj, entry.getValue());
        }
        
        return obj;
    }
}
```

### **åœºæ™¯3ï¼šæ•°æ®åº“ ORM æ¡†æ¶**
```java
public class SimpleORM {
    // å°†ResultSetæ˜ å°„åˆ°å¯¹è±¡
    public static <T> T mapRow(ResultSet rs, Class<T> clazz) throws Exception {
        T obj = clazz.newInstance();
        ResultSetMetaData metaData = rs.getMetaData();
        
        for (int i = 1; i <= metaData.getColumnCount(); i++) {
            String columnName = metaData.getColumnLabel(i);
            Object columnValue = rs.getObject(i);
            
            // é©¼å³°å‘½åè½¬æ¢ï¼šuser_name -> userName
            String fieldName = toCamelCase(columnName);
            
            try {
                Field field = clazz.getDeclaredField(fieldName);
                field.setAccessible(true);
                
                // ç±»å‹è½¬æ¢
                if (columnValue != null) {
                    Object convertedValue = convertType(columnValue, field.getType());
                    field.set(obj, convertedValue);
                }
            } catch (NoSuchFieldException e) {
                // å­—æ®µä¸å­˜åœ¨ï¼Œè·³è¿‡
            }
        }
        
        return obj;
    }
}
```

### **åœºæ™¯4ï¼šæ’ä»¶ç³»ç»Ÿ**
```java
public class PluginManager {
    private List<Object> plugins = new ArrayList<>();
    
    public void loadPlugin(String className) throws Exception {
        Class<?> pluginClass = Class.forName(className);
        
        // æ£€æŸ¥æ˜¯å¦å®ç°äº†Pluginæ¥å£
        if (Plugin.class.isAssignableFrom(pluginClass)) {
            Object plugin = pluginClass.newInstance();
            plugins.add(plugin);
            
            // è‡ªåŠ¨è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
            try {
                Method initMethod = pluginClass.getMethod("init");
                initMethod.invoke(plugin);
            } catch (NoSuchMethodException e) {
                // æ²¡æœ‰initæ–¹æ³•ï¼Œå¿½ç•¥
            }
        }
    }
    
    public void executeAll() throws Exception {
        for (Object plugin : plugins) {
            Method executeMethod = plugin.getClass().getMethod("execute");
            executeMethod.invoke(plugin);
        }
    }
}
```

## ğŸ“š **10. æ€»ç»“å¯¹æ¯”**

| ç‰¹æ€§         | ç›´æ¥è°ƒç”¨ | åå°„è°ƒç”¨       |
| ------------ | -------- | -------------- |
| **æ€§èƒ½**     | å¿«       | æ…¢ï¼ˆ50-100å€ï¼‰ |
| **çµæ´»æ€§**   | ä½       | é«˜             |
| **å®‰å…¨æ€§**   | é«˜       | ä½             |
| **ç¼–è¯‘æ£€æŸ¥** | æœ‰       | æ—              |
| **ä½¿ç”¨åœºæ™¯** | å¸¸è§„å¼€å‘ | æ¡†æ¶ã€åŠ¨æ€åŠŸèƒ½ |

### **ä»€ä¹ˆæ—¶å€™ç”¨åå°„ï¼Ÿ**
1. **å¼€å‘æ¡†æ¶**ï¼šSpringã€MyBatisã€Hibernate
2. **åŠ¨æ€ä»£ç†**ï¼šAOPã€RPC
3. **æ³¨è§£å¤„ç†å™¨**ï¼šLombokã€Jackson
4. **æ’ä»¶ç³»ç»Ÿ**ï¼šå¯æ‰©å±•æ¶æ„
5. **æµ‹è¯•å·¥å…·**ï¼šMockitoã€JUnit
6. **åºåˆ—åŒ–**ï¼šJSONã€XMLè½¬æ¢

### **ä»€ä¹ˆæ—¶å€™ä¸ç”¨åå°„ï¼Ÿ**
1. **æ€§èƒ½æ•æ„Ÿ**ï¼šé«˜é¢‘è°ƒç”¨çš„ä»£ç 
2. **ä¸šåŠ¡é€»è¾‘**ï¼šå¸¸è§„çš„ä¸šåŠ¡å¼€å‘
3. **ç®€å•åœºæ™¯**ï¼šå¯ä»¥ç›´æ¥è°ƒç”¨çš„åœ°æ–¹
4. **å®‰å…¨æ•æ„Ÿ**ï¼šéœ€è¦ä¸¥æ ¼æ§åˆ¶è®¿é—®çš„åœºæ™¯

### **æœ€ä½³å®è·µ**
1. **ç¼“å­˜åå°„å¯¹è±¡**ï¼šMethodã€Fieldã€Constructor
2. **å°½é‡ä½¿ç”¨ getDeclaredXXX**ï¼šé¿å…ç»§æ‰¿é“¾çš„å½±å“
3. **å¤„ç†å¥½ setAccessible(true)** çš„å‰¯ä½œç”¨
4. **ä½¿ç”¨ MethodHandle æ›¿ä»£**ï¼šJDK7+ çš„æ€§èƒ½ä¼˜åŒ–
5. **è€ƒè™‘å®‰å…¨æ€§**ï¼šåœ¨å®‰å…¨ç®¡ç†å™¨ä¸‹ä½¿ç”¨

**è®°ä½ï¼šåå°„æ˜¯å¼ºå¤§çš„å·¥å…·ï¼Œä½†è¦ç”¨åœ¨æ­£ç¡®çš„åœ°æ–¹ï¼**