# ä¹è§‚é” vs æ‚²è§‚é”

## ğŸ“Š æ ¸å¿ƒå¯¹æ¯”ä¸€è§ˆè¡¨

| ç‰¹æ€§           | ä¹è§‚é” (Optimistic Lock)                 | æ‚²è§‚é” (Pessimistic Lock)            |
| -------------- | ---------------------------------------- | ------------------------------------ |
| **åŸºæœ¬æ€æƒ³**   | è®¤ä¸ºå¹¶å‘å†²çªå¾ˆå°‘å‘ç”Ÿï¼Œå…ˆæ“ä½œï¼Œæäº¤æ—¶æ£€æŸ¥ | è®¤ä¸ºå¹¶å‘å†²çªç»å¸¸å‘ç”Ÿï¼Œå…ˆåŠ é”ï¼Œå†æ“ä½œ |
| **å®ç°æ–¹å¼**   | ç‰ˆæœ¬å·ã€æ—¶é—´æˆ³ã€CAS                      | æ•°æ®åº“è¡Œé”ã€è¡¨é”ã€Java synchronized  |
| **ä½¿ç”¨åœºæ™¯**   | è¯»å¤šå†™å°‘ï¼Œå†²çªæ¦‚ç‡ä½                     | å†™å¤šè¯»å°‘ï¼Œå†²çªæ¦‚ç‡é«˜                 |
| **æ€§èƒ½**       | é«˜ï¼ˆæ— é”æœŸé—´å¯å¹¶å‘ï¼‰                     | ä½ï¼ˆä¸²è¡Œæ‰§è¡Œï¼Œé˜»å¡ç­‰å¾…ï¼‰             |
| **æ•°æ®ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´ï¼ˆå¯èƒ½å¤±è´¥é‡è¯•ï¼‰                 | å¼ºä¸€è‡´ï¼ˆä¿è¯æˆåŠŸï¼‰                   |
| **é€‚ç”¨åœºæ™¯**   | å•†å“åº“å­˜ã€è´¦æˆ·ä½™é¢ã€ç‚¹èµæ•°               | æ”¯ä»˜ã€è®¢å•å¤„ç†ã€é“¶è¡Œè½¬è´¦             |

---

## ğŸ”’ æ‚²è§‚é” (Pessimistic Lock)

### åŸç†
**"å…ˆé”å®šï¼Œå†æ“ä½œ"** - æ€»æ˜¯å‡è®¾æœ€åæƒ…å†µï¼Œè®¤ä¸ºåˆ«äººä¼šä¿®æ”¹æ•°æ®ï¼Œæ‰€ä»¥åœ¨æ“ä½œå‰å…ˆåŠ é”ã€‚

### å®ç°æ–¹å¼

#### 1. **æ•°æ®åº“æ‚²è§‚é”**
```sql
-- MySQL: SELECT ... FOR UPDATE (è¡Œçº§é”)
BEGIN;
SELECT * FROM account WHERE id = 1 FOR UPDATE; -- åŠ é”
UPDATE account SET balance = balance - 100 WHERE id = 1;
COMMIT;

-- æˆ–è€…ä½¿ç”¨ LOCK IN SHARE MODE (å…±äº«é”)
SELECT * FROM product WHERE id = 100 LOCK IN SHARE MODE;
```

#### 2. **Java synchronized**
```java
public synchronized void deductStock(Long productId) {
    // è¿™æ®µä»£ç åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œ
    Product product = productDao.selectById(productId);
    if (product.getStock() > 0) {
        product.setStock(product.getStock() - 1);
        productDao.updateById(product);
    }
}
```

#### 3. **ReentrantLock**
```java
private final ReentrantLock lock = new ReentrantLock();

public void processOrder() {
    lock.lock();  // åŠ é”
    try {
        // ä¸šåŠ¡é€»è¾‘
        updateInventory();
    } finally {
        lock.unlock();  // å¿…é¡»é‡Šæ”¾é”
    }
}
```

### ä¼˜ç‚¹
- **å¼ºä¸€è‡´æ€§**ï¼šä¿è¯æ•°æ®ç»å¯¹æ­£ç¡®
- **ç®€å•ç›´è§‚**ï¼šé€»è¾‘å®¹æ˜“ç†è§£
- **ä¸ä¼šå¤±è´¥é‡è¯•**ï¼šä¸€æ¬¡æˆåŠŸæˆ–å¤±è´¥

### ç¼ºç‚¹
- **æ€§èƒ½å·®**ï¼šä¸²è¡Œæ‰§è¡Œï¼Œååé‡ä½
- **æ­»é”é£é™©**ï¼šéœ€è¦å°å¿ƒå¤„ç†é”é¡ºåº
- **æ‰©å±•æ€§å·®**ï¼šä¸é€‚åˆé«˜å¹¶å‘åœºæ™¯

---

## ğŸ˜Š ä¹è§‚é” (Optimistic Lock)

### åŸç†
**"å…ˆæ“ä½œï¼Œå†æ£€æŸ¥"** - è®¤ä¸ºå†²çªå¾ˆå°‘å‘ç”Ÿï¼Œå…ˆæ‰§è¡Œæ“ä½œï¼Œæäº¤æ—¶æ£€æŸ¥æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚

### å®ç°æ–¹å¼

#### 1. **ç‰ˆæœ¬å·æœºåˆ¶ (æœ€å¸¸ç”¨)**
```sql
-- æ•°æ®åº“è¡¨å¢åŠ  version å­—æ®µ
CREATE TABLE product (
    id BIGINT PRIMARY KEY,
    name VARCHAR(100),
    stock INT,
    version INT DEFAULT 0  -- ç‰ˆæœ¬å·å­—æ®µ
);
```

```java
// Java ä»£ç å®ç°
public boolean deductStockWithVersion(Long productId) {
    Product product = productDao.selectById(productId);
    
    if (product.getStock() <= 0) {
        return false;
    }
    
    // æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬å·
    int count = productDao.update()
            .setSql("stock = stock - 1")
            .set("version", product.getVersion() + 1)  // ç‰ˆæœ¬å·+1
            .eq("id", productId)
            .eq("version", product.getVersion())  // é‡è¦ï¼šæ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å˜åŒ–
            .update();
    
    return count > 0;  // count>0è¡¨ç¤ºæ›´æ–°æˆåŠŸï¼Œå¦åˆ™è¢«å…¶ä»–äººä¿®æ”¹è¿‡äº†
}
```

#### 2. **æ—¶é—´æˆ³æœºåˆ¶**
```sql
CREATE TABLE order (
    id BIGINT PRIMARY KEY,
    order_no VARCHAR(50),
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 3. **CAS (Compare And Swap) - JavaåŸå­ç±»**
```java
// JavaåŸå­æ“ä½œå®ç°ä¹è§‚é”
private AtomicInteger stock = new AtomicInteger(100);

public boolean deductStock() {
    int current, next;
    do {
        current = stock.get();  // è·å–å½“å‰å€¼
        if (current <= 0) {
            return false;
        }
        next = current - 1;  // è®¡ç®—æ–°å€¼
    } while (!stock.compareAndSet(current, next));  // CASæ“ä½œ
    
    return true;
}
```

### ä¼˜ç‚¹
- **é«˜æ€§èƒ½**ï¼šæ— é”æœŸé—´æ”¯æŒé«˜å¹¶å‘
- **æ— æ­»é”**ï¼šä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜
- **é€‚åˆé«˜å¹¶å‘**ï¼šè¯»å¤šå†™å°‘çš„åœºæ™¯è¡¨ç°ä¼˜ç§€

### ç¼ºç‚¹
- **å¯èƒ½å¤±è´¥**ï¼šéœ€è¦å¤„ç†æ›´æ–°å¤±è´¥çš„æƒ…å†µ
- **ABAé—®é¢˜**ï¼šéœ€è¦é¢å¤–å¤„ç†ï¼ˆç‰ˆæœ¬å·å¯è§£å†³ï¼‰
- **å®ç°å¤æ‚**ï¼šéœ€è¦é‡è¯•æœºåˆ¶

---

## ğŸ¯ å®é™…åº”ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šå•†å“ç§’æ€åº“å­˜æ‰£å‡

```java
@Service
public class SeckillService {
    
    // æ–¹æ³•1ï¼šæ‚²è§‚é”å®ç°ï¼ˆæ€§èƒ½å·®ï¼‰
    @Transactional
    public synchronized boolean seckillWithPessimistic(Long productId) {
        Product product = productDao.selectById(productId);
        if (product.getStock() > 0) {
            product.setStock(product.getStock() - 1);
            productDao.updateById(product);
            return true;
        }
        return false;
    }
    
    // æ–¹æ³•2ï¼šä¹è§‚é”å®ç°ï¼ˆæ¨èï¼‰
    @Transactional
    public boolean seckillWithOptimistic(Long productId) {
        int retryCount = 3;  // é‡è¯•3æ¬¡
        
        for (int i = 0; i < retryCount; i++) {
            Product product = productDao.selectById(productId);
            
            if (product.getStock() <= 0) {
                return false;
            }
            
            // ä½¿ç”¨ç‰ˆæœ¬å·æ›´æ–°
            int updated = productDao.updateStockWithVersion(
                productId, 
                product.getStock() - 1, 
                product.getVersion()
            );
            
            if (updated > 0) {
                return true;  // æ›´æ–°æˆåŠŸ
            }
            
            // æ›´æ–°å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
            try {
                Thread.sleep(50);  // çŸ­æš‚ç­‰å¾…
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
        
        return false;  // é‡è¯•åä»ç„¶å¤±è´¥
    }
    
    // æ–¹æ³•3ï¼šMySQLè¡Œé”å®ç°ï¼ˆæŠ˜ä¸­æ–¹æ¡ˆï¼‰
    @Transactional
    public boolean seckillWithMySQLRowLock(Long productId) {
        // å…ˆåŠ é”æŸ¥è¯¢
        Product product = productDao.selectForUpdate(productId);
        
        if (product.getStock() > 0) {
            productDao.updateStock(productId, product.getStock() - 1);
            return true;
        }
        
        return false;
    }
}
```

### åœºæ™¯2ï¼šè´¦æˆ·ä½™é¢æ›´æ–°

```java
@Service
public class AccountService {
    
    // ä¹è§‚é”ï¼šç‰ˆæœ¬å·æ–¹å¼
    public boolean transferWithOptimistic(Long fromId, Long toId, BigDecimal amount) {
        int maxRetries = 5;
        
        for (int i = 0; i < maxRetries; i++) {
            Account fromAccount = accountDao.selectById(fromId);
            Account toAccount = accountDao.selectById(toId);
            
            // æ£€æŸ¥ä½™é¢
            if (fromAccount.getBalance().compareTo(amount) < 0) {
                throw new RuntimeException("ä½™é¢ä¸è¶³");
            }
            
            // è®¡ç®—æ–°ä½™é¢
            BigDecimal newFromBalance = fromAccount.getBalance().subtract(amount);
            BigDecimal newToBalance = toAccount.getBalance().add(amount);
            
            // ä½¿ç”¨äº‹åŠ¡æ›´æ–°ï¼ˆå¸¦ç‰ˆæœ¬æ£€æŸ¥ï¼‰
            try {
                boolean success = accountDao.updateWithVersion(
                    fromId, newFromBalance, fromAccount.getVersion(),
                    toId, newToBalance, toAccount.getVersion()
                );
                
                if (success) {
                    return true;
                }
            } catch (OptimisticLockingFailureException e) {
                // ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
                if (i == maxRetries - 1) {
                    throw new RuntimeException("è½¬è´¦å¤±è´¥ï¼Œè¯·é‡è¯•");
                }
            }
        }
        
        return false;
    }
    
    // æ‚²è§‚é”ï¼šæ•°æ®åº“è¡Œé”
    @Transactional
    public boolean transferWithPessimistic(Long fromId, Long toId, BigDecimal amount) {
        // æŒ‰å›ºå®šé¡ºåºåŠ é”ï¼Œé¿å…æ­»é”ï¼ˆå…ˆé”IDå°çš„ï¼‰
        Long firstId = Math.min(fromId, toId);
        Long secondId = Math.max(fromId, toId);
        
        // é”å®šç¬¬ä¸€ä¸ªè´¦æˆ·
        Account firstAccount = accountDao.selectForUpdate(firstId);
        // é”å®šç¬¬äºŒä¸ªè´¦æˆ·
        Account secondAccount = accountDao.selectForUpdate(secondId);
        
        // ä¸šåŠ¡é€»è¾‘...
        return true;
    }
}
```

---

## ğŸ“ å¦‚ä½•é€‰æ‹©ï¼Ÿ

### é€‰æ‹©ä¹è§‚é”å½“ï¼š
- âœ… è¯»æ“ä½œè¿œå¤šäºå†™æ“ä½œ
- âœ… å†²çªæ¦‚ç‡ä½äº20%
- âœ… ç³»ç»Ÿéœ€è¦é«˜ååé‡
- âœ… å¯ä»¥æ¥å—é‡è¯•æœºåˆ¶
- âœ… ä¸šåŠ¡å¯ä»¥å®¹å¿å¶å°”å¤±è´¥

### é€‰æ‹©æ‚²è§‚é”å½“ï¼š
- âœ… å†™æ“ä½œé¢‘ç¹
- âœ… å†²çªæ¦‚ç‡é«˜äº50%
- âœ… æ•°æ®ä¸€è‡´æ€§è¦æ±‚æé«˜
- âœ… ä¸šåŠ¡ä¸èƒ½æ¥å—å¤±è´¥é‡è¯•
- âœ… å¹¶å‘é‡ä¸æ˜¯ç‰¹åˆ«é«˜

### æ··åˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰
```java
public class HybridLockService {
    
    // è¯»å¤šå†™å°‘æ—¶ç”¨ä¹è§‚é”ï¼Œå†™å¤šè¯»å°‘æ—¶ç”¨æ‚²è§‚é”
    public boolean smartDeduct(Long productId) {
        // 1. å…ˆå°è¯•ä¹è§‚é”ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
        if (tryOptimisticLock(productId)) {
            return true;
        }
        
        // 2. ä¹è§‚é”å¤±è´¥ï¼Œæ”¹ç”¨æ‚²è§‚é”
        return tryPessimisticLock(productId);
    }
    
    private boolean tryOptimisticLock(Long productId) {
        // ä¹è§‚é”å®ç°...
    }
    
    @Transactional
    private synchronized boolean tryPessimisticLock(Long productId) {
        // æ‚²è§‚é”å®ç°...
    }
}
```

---

## ğŸ”§ æœ€ä½³å®è·µå»ºè®®

### 1. **é»˜è®¤ä½¿ç”¨ä¹è§‚é”**
```java
// å¤§å¤šæ•°åœºæ™¯ä¸‹ä¼˜å…ˆä½¿ç”¨ä¹è§‚é”
@Transactional
public boolean updateWithRetry(Entity entity) {
    int maxRetries = 3;
    for (int i = 0; i < maxRetries; i++) {
        try {
            return dao.updateWithVersion(entity) > 0;
        } catch (OptimisticLockException e) {
            if (i == maxRetries - 1) throw e;
            // é‡è¯•å‰åˆ·æ–°æ•°æ®
            entity = dao.refresh(entity);
        }
    }
    return false;
}
```

### 2. **å…³é”®ä¸šåŠ¡ç”¨æ‚²è§‚é”**
```java
// æ”¯ä»˜ã€èµ„é‡‘äº¤æ˜“ç­‰ç”¨æ‚²è§‚é”
@Transactional
public PaymentResult processPayment(PaymentRequest request) {
    // å¯¹è´¦æˆ·åŠ é”
    Account account = accountDao.selectForUpdate(request.getAccountId());
    
    // æ£€æŸ¥ã€æ‰£æ¬¾ã€è®°å½•
    if (account.getBalance() >= request.getAmount()) {
        accountDao.deductBalance(request.getAccountId(), request.getAmount());
        paymentDao.createRecord(request);
        return PaymentResult.success();
    }
    
    return PaymentResult.failed("ä½™é¢ä¸è¶³");
}
```

### 3. **ç»“åˆä¸šåŠ¡ç‰¹æ€§é€‰æ‹©**
- **ç”µå•†åº“å­˜**ï¼šä¹è§‚é” + é‡è¯•ï¼ˆè¯»å¤šå†™å°‘ï¼‰
- **é“¶è¡Œè½¬è´¦**ï¼šæ‚²è§‚é”ï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
- **ç¤¾äº¤ç‚¹èµ**ï¼šä¹è§‚é”/CASï¼ˆå¹¶å‘é«˜ï¼Œå¯æ¥å—å»¶è¿Ÿï¼‰
- **è®¢å•çŠ¶æ€**ï¼šä¹è§‚é”ï¼ˆçŠ¶æ€å˜æ›´å°‘ï¼‰

---

## â— æ³¨æ„äº‹é¡¹

1. **ä¹è§‚é”çš„é‡è¯•æ¬¡æ•°**ï¼šä¸€èˆ¬3-5æ¬¡ï¼Œå¤ªå¤šä¼šæ‹–å®ç³»ç»Ÿ
2. **æ‚²è§‚é”çš„ç²’åº¦**ï¼šå°½é‡é”è¡Œï¼Œä¸è¦é”è¡¨
3. **æ­»é”é¢„é˜²**ï¼šæŒ‰å›ºå®šé¡ºåºåŠ é”ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´
4. **ABAé—®é¢˜**ï¼šç‰ˆæœ¬å·æ¯”æ—¶é—´æˆ³æ›´å¥½ï¼Œèƒ½è§£å†³ABAé—®é¢˜
5. **ç›‘æ§æŒ‡æ ‡**ï¼šç›‘æ§é”ç«äº‰ã€é‡è¯•æ¬¡æ•°ã€å¤±è´¥ç‡

## æ€»ç»“
- **ä¹è§‚é”**ï¼šé€‚åˆ**é«˜å¹¶å‘è¯»ã€ä½å†²çª**åœºæ™¯ï¼Œå¦‚å•†å“æµè§ˆã€ç¤¾äº¤feed
- **æ‚²è§‚é”**ï¼šé€‚åˆ**å¼ºä¸€è‡´æ€§ã€é«˜å†²çª**åœºæ™¯ï¼Œå¦‚é‡‘èäº¤æ˜“ã€åº“å­˜æ‰£å‡
- **ç°ä»£ç³»ç»Ÿ**ï¼šé€šå¸¸**ä¼˜å…ˆä½¿ç”¨ä¹è§‚é”**ï¼Œåªåœ¨å¿…è¦æ—¶ç”¨æ‚²è§‚é”